# =====================================================================
# Upstream Java hwplib Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ ÏûêÎèô Ï∂îÏ†Å ÏõåÌÅ¨ÌîåÎ°úÏö∞
# 
# Ïù¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞Îäî ÏõêÎ≥∏ Java hwplib ÏÑúÎ∏åÎ™®ÎìàÏùò Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ÏùÑ Í∞êÏßÄÌïòÍ≥†,
# AI ÏΩîÎî© ÏóêÏù¥Ï†ÑÌä∏Í∞Ä .NET Î≤ÑÏ†ÑÏóê Î∞òÏòÅÌï† Ïàò ÏûàÎèÑÎ°ù Ïù¥ÏäàÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.
# =====================================================================

name: Sync Upstream Java Changes

on:
  schedule:
    # 3ÏùºÎßàÎã§ UTC 00:00 (KST 09:00) Ïã§Ìñâ
    - cron: '0 0 */3 * *'
  workflow_dispatch:  # ÏàòÎèô Ìä∏Î¶¨Í±∞ ÏßÄÏõê

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      
      - name: Check for upstream changes
        id: check
        run: |
          cd hwplib
          git fetch origin
          
          # ÌòÑÏû¨ ÏÑúÎ∏åÎ™®Îìà HEADÏôÄ ÏõêÍ≤© main Î∏åÎûúÏπò ÎπÑÍµê
          CURRENT_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse origin/main)
          
          if [ "$CURRENT_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            
            # Î≥ÄÍ≤ΩÎêú Ïª§Î∞ã Î™©Î°ù Ï†ÄÏû•
            echo "## ÏÉàÎ°úÏö¥ Ïª§Î∞ã" > ../upstream_changes.md
            echo "" >> ../upstream_changes.md
            git log HEAD..origin/main --format="- **%h** %s (%an, %ad)" --date=short >> ../upstream_changes.md
            
            # Î≥ÄÍ≤ΩÎêú Java ÌååÏùº Î™©Î°ù Ï†ÄÏû•
            echo "" >> ../upstream_changes.md
            echo "## Î≥ÄÍ≤ΩÎêú Java ÌååÏùº" >> ../upstream_changes.md
            echo "" >> ../upstream_changes.md
            echo "\`\`\`" >> ../upstream_changes.md
            git diff HEAD..origin/main --name-only | grep "\.java$" >> ../upstream_changes.md || echo "(Java ÌååÏùº Î≥ÄÍ≤Ω ÏóÜÏùå)" >> ../upstream_changes.md
            echo "\`\`\`" >> ../upstream_changes.md
            
            # Ïª§Î∞ã Ïàò Í≥ÑÏÇ∞
            COMMIT_COUNT=$(git log HEAD..origin/main --oneline | wc -l)
            echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
            
            # Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Ï∂îÏ∂ú (pom.xmlÏóêÏÑú)
            UPSTREAM_VERSION=$(grep -m1 "<version>" pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
            echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No upstream changes detected."
          fi
      
      - name: Create Issue for AI Agent
        if: steps.check.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changes = fs.readFileSync('upstream_changes.md', 'utf8');
            const commitCount = '${{ steps.check.outputs.commit_count }}';
            const upstreamVersion = '${{ steps.check.outputs.upstream_version }}';
            
            const issueBody = `## üîÑ Java hwplib ÏóÖÏä§Ìä∏Î¶º Î≥ÄÍ≤Ω Í∞êÏßÄ

            **Í∞êÏßÄÎêú Ïª§Î∞ã Ïàò**: ${commitCount}Í∞ú
            **ÏóÖÏä§Ìä∏Î¶º Î≤ÑÏ†Ñ**: ${upstreamVersion}

            ${changes}

            ---

            ## üìã AI ÏóêÏù¥Ï†ÑÌä∏ ÏûëÏóÖ ÏöîÏ≤≠

            @copilot Îã§Ïùå ÏûëÏóÖÏùÑ ÏàòÌñâÌï¥Ï£ºÏÑ∏Ïöî:

            1. ÏúÑ Î≥ÄÍ≤ΩÎêú Java ÌååÏùºÎì§ÏùÑ Î∂ÑÏÑùÌï¥Ï£ºÏÑ∏Ïöî
            2. Í∞Å Java ÌååÏùºÏóê ÎåÄÏùëÌïòÎäî C# ÌååÏùºÏùÑ Ï∞æÏïÑÏ£ºÏÑ∏Ïöî (ÌååÏùº ÏÉÅÎã® \`// Java Original:\` Ï£ºÏÑù Ï∞∏Ï°∞)
            3. Java Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ÏùÑ C# ÏΩîÎìúÏóê Î∞òÏòÅÌï¥Ï£ºÏÑ∏Ïöî
            4. ÎπåÎìú Î∞è ÌÖåÏä§Ìä∏Î•º Ïã§ÌñâÌï¥Ï£ºÏÑ∏Ïöî
            5. Î≤ÑÏ†Ñ Î≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÌïÑÏöîÌïúÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî

            ### Ï∞∏Í≥† Î¨∏ÏÑú
            - [AGENTS.md](./AGENTS.md) - ÏΩîÎî© ÏóêÏù¥Ï†ÑÌä∏ Í∞ÄÏù¥Îìú
            - [docs/TRANSLATION_STATUS.md](./docs/TRANSLATION_STATUS.md) - Î≤àÏó≠ ÌòÑÌô©

            ---
            *Ïù¥ Ïù¥ÏäàÎäî ÏûêÎèôÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.*
            `;

            // Í∏∞Ï°¥Ïóê Ïó¥Î¶∞ ÎèôÏùºÌïú Ïù¥ÏäàÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            if (existingIssues.data.length > 0) {
              // Í∏∞Ï°¥ Ïù¥ÏäàÏóê ÏΩîÎ©òÌä∏ Ï∂îÍ∞Ä
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## üîÑ Ï∂îÍ∞Ä Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ Í∞êÏßÄ\n\n${changes}`
              });
              console.log(`Updated existing issue #${existingIssues.data[0].number}`);
            } else {
              // ÏÉà Ïù¥Ïäà ÏÉùÏÑ±
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîÑ Upstream hwplib Î≥ÄÍ≤Ω Í∞êÏßÄ (${commitCount}Í∞ú Ïª§Î∞ã)`,
                body: issueBody,
                labels: ['upstream-sync', 'ai-agent-task']
              });
              console.log(`Created new issue #${newIssue.data.number}`);
            }

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.changes }}" == "true" ]; then
            echo "### ‚úÖ ÏóÖÏä§Ìä∏Î¶º Î≥ÄÍ≤Ω Í∞êÏßÄÎê®" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Ïª§Î∞ã Ïàò: ${{ steps.check.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- ÏóÖÏä§Ìä∏Î¶º Î≤ÑÏ†Ñ: ${{ steps.check.outputs.upstream_version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Ïù¥ÏäàÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. AI ÏóêÏù¥Ï†ÑÌä∏Í∞Ä Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ÏùÑ Í≤ÄÌÜ†Ìï† ÏòàÏ†ïÏûÖÎãàÎã§." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ÑπÔ∏è ÏóÖÏä§Ìä∏Î¶º Î≥ÄÍ≤Ω ÏóÜÏùå" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ÌòÑÏû¨ ÏÑúÎ∏åÎ™®ÎìàÏù¥ ÏµúÏã† ÏÉÅÌÉúÏûÖÎãàÎã§." >> $GITHUB_STEP_SUMMARY
          fi
